name: Create Draft Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true

      # Check if tag for current version already exists
      - name: Check for existing tag
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if git tag -l "v${VERSION}" | grep -q .; then
            echo "::error::Tag v${VERSION} already exists"
            exit 1
          fi
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

      - run: corepack enable
      - uses: actions/setup-node@v4
        with:
          node-version-file: 'package.json'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm exec playwright install --with-deps chromium
      - run: pnpm lint
      - run: pnpm build
      - run: pnpm test

      - name: Create draft release
        run: |
          gh release create "v${VERSION}" \
            --draft \
            --title "v${VERSION}" \
            --generate-notes \
            dist/block-oli_*.zip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
